// SPDX-License-Identifier: GPL-2.0
/*
 * Tegra234 Power Domain and Regulator Configurations
 *
 * This file contains common power domain and regulator configurations
 * for NVIDIA Tegra234 (Jetson Orin) platforms.
 *
 * Usage: Include this file in your device tree:
 *   #include "tegra234-power.dtsi"
 */

/*
 * Fixed Voltage Regulators
 * =========================
 * These are simple on/off regulators without voltage control
 */

/ {
    regulators {
        compatible = "simple-bus";
        #address-cells = <1>;
        #size-cells = <0>;

        /* 3.3V main rail */
        vdd_3v3_sys: regulator@0 {
            compatible = "regulator-fixed";
            reg = <0>;
            regulator-name = "vdd-3v3-sys";
            regulator-min-microvolt = <3300000>;
            regulator-max-microvolt = <3300000>;
            regulator-always-on;
            regulator-boot-on;
        };

        /* 5V main rail */
        vdd_5v0_sys: regulator@1 {
            compatible = "regulator-fixed";
            reg = <1>;
            regulator-name = "vdd-5v0-sys";
            regulator-min-microvolt = <5000000>;
            regulator-max-microvolt = <5000000>;
            regulator-always-on;
            regulator-boot-on;
        };

        /* 1.8V I/O rail */
        vdd_1v8: regulator@2 {
            compatible = "regulator-fixed";
            reg = <2>;
            regulator-name = "vdd-1v8";
            regulator-min-microvolt = <1800000>;
            regulator-max-microvolt = <1800000>;
            regulator-always-on;
            regulator-boot-on;
            vin-supply = <&vdd_3v3_sys>;
        };

        /* 1.2V digital core */
        vdd_1v2: regulator@3 {
            compatible = "regulator-fixed";
            reg = <3>;
            regulator-name = "vdd-1v2";
            regulator-min-microvolt = <1200000>;
            regulator-max-microvolt = <1200000>;
            regulator-always-on;
            regulator-boot-on;
            vin-supply = <&vdd_3v3_sys>;
        };

        /* Camera 2.8V analog */
        vdd_cam_2v8: regulator@4 {
            compatible = "regulator-fixed";
            reg = <4>;
            regulator-name = "vdd-cam-2v8";
            regulator-min-microvolt = <2800000>;
            regulator-max-microvolt = <2800000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(H, 4) 0>;
            vin-supply = <&vdd_3v3_sys>;
        };

        /* Camera 1.8V digital I/O */
        vdd_cam_1v8: regulator@5 {
            compatible = "regulator-fixed";
            reg = <5>;
            regulator-name = "vdd-cam-1v8";
            regulator-min-microvolt = <1800000>;
            regulator-max-microvolt = <1800000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(H, 5) 0>;
            vin-supply = <&vdd_1v8>;
        };

        /* Camera 1.2V digital core */
        vdd_cam_1v2: regulator@6 {
            compatible = "regulator-fixed";
            reg = <6>;
            regulator-name = "vdd-cam-1v2";
            regulator-min-microvolt = <1200000>;
            regulator-max-microvolt = <1200000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(H, 6) 0>;
            vin-supply = <&vdd_1v2>;
        };

        /* HDMI 5V */
        vdd_hdmi_5v0: regulator@7 {
            compatible = "regulator-fixed";
            reg = <7>;
            regulator-name = "vdd-hdmi-5v0";
            regulator-min-microvolt = <5000000>;
            regulator-max-microvolt = <5000000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(N, 1) 0>;
            vin-supply = <&vdd_5v0_sys>;
        };

        /* USB VBUS */
        vdd_usb_5v0: regulator@8 {
            compatible = "regulator-fixed";
            reg = <8>;
            regulator-name = "vdd-usb-5v0";
            regulator-min-microvolt = <5000000>;
            regulator-max-microvolt = <5000000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(Q, 4) 0>;
            vin-supply = <&vdd_5v0_sys>;
        };

        /* Fan 5V */
        vdd_fan_5v0: regulator@9 {
            compatible = "regulator-fixed";
            reg = <9>;
            regulator-name = "vdd-fan-5v0";
            regulator-min-microvolt = <5000000>;
            regulator-max-microvolt = <5000000>;
            enable-active-high;
            gpio = <&tegra_main_gpio TEGRA234_MAIN_GPIO(P, 4) 0>;
            vin-supply = <&vdd_5v0_sys>;
        };
    };
};

/*
 * Power Domains
 * =============
 * Tegra234 uses BPMP (Boot and Power Management Processor) for power management
 */

&bpmp {
    i2c {
        status = "okay";
    };

    /* BPMP thermal zones */
    thermal {
        status = "okay";
    };
};

/*
 * Power Domain Definitions
 * ========================
 * Reference power domains for various subsystems
 */

/* Example power domain usage for PCIe */
&pcie_c5 {
    power-domains = <&bpmp TEGRA234_POWER_DOMAIN_PCIEX4A>;
    interconnects = <&mc TEGRA234_MEMORY_CLIENT_PCIE5AR>,
                    <&mc TEGRA234_MEMORY_CLIENT_PCIE5AW>;
    interconnect-names = "dma-mem", "write";
};

/* Example power domain for display */
&display {
    power-domains = <&bpmp TEGRA234_POWER_DOMAIN_DISP>;
};

/* Example power domain for GPU */
&gpu {
    power-domains = <&bpmp TEGRA234_POWER_DOMAIN_GPU>;
};

/*
 * Voltage Monitoring (INA3221)
 * =============================
 * Triple-channel power monitor for current/voltage/power measurement
 */

&i2c_pmc {
    status = "okay";

    power_monitor: ina3221@40 {
        compatible = "ti,ina3221";
        reg = <0x40>;
        #address-cells = <1>;
        #size-cells = <0>;

        /* Channel 0: GPU */
        input@0 {
            reg = <0>;
            label = "GPU";
            shunt-resistor-micro-ohms = <5000>;  /* 5 milliohm */
        };

        /* Channel 1: CPU */
        input@1 {
            reg = <1>;
            label = "CPU";
            shunt-resistor-micro-ohms = <5000>;
        };

        /* Channel 2: SOC */
        input@2 {
            reg = <2>;
            label = "SOC";
            shunt-resistor-micro-ohms = <5000>;
        };
    };
};

/*
 * Reading Power Metrics:
 * ======================
 *
 * INA3221 power monitor:
 *   ls /sys/bus/i2c/devices/*/hwmon/hwmon*/
 *
 *   # Voltage (mV)
 *   cat /sys/bus/i2c/devices/*/hwmon/hwmon*/in1_input
 *
 *   # Current (mA)
 *   cat /sys/bus/i2c/devices/*/hwmon/hwmon*/curr1_input
 *
 *   # Power (mW)
 *   cat /sys/bus/i2c/devices/*/hwmon/hwmon*/power1_input
 *
 * Power domain status:
 *   cat /sys/kernel/debug/bpmp/debug/power/domain_info
 *
 * Regulator status:
 *   cat /sys/class/regulator/regulator*/name
 *   cat /sys/class/regulator/regulator*/microvolts
 *   cat /sys/class/regulator/regulator*/state
 */

/*
 * Power Optimization Tips:
 * ========================
 *
 * 1. Runtime PM:
 *    - Enable runtime power management for unused devices
 *    - echo auto > /sys/bus/*/devices/*/power/control
 *
 * 2. CPU frequency scaling:
 *    - Use ondemand or schedutil governor
 *    - echo schedutil > /sys/devices/system/cpu/cpufreq/policy*/scaling_governor
 *
 * 3. GPU power management:
 *    - Enable GPU DVFS (Dynamic Voltage and Frequency Scaling)
 *    - cat /sys/kernel/debug/bpmp/debug/clk/nafll_gpu/rate
 *
 * 4. Display power:
 *    - Reduce brightness when possible
 *    - Enable DPMS (Display Power Management Signaling)
 *
 * 5. Peripheral power:
 *    - Disable unused interfaces (UART, SPI, I2C)
 *    - Use power-domains in device tree
 *    - Enable regulator-boot-on only when necessary
 */

/*
 * Regulator Properties Reference:
 * ================================
 *
 * regulator-name: Human-readable name
 * regulator-min-microvolt: Minimum voltage in microvolts
 * regulator-max-microvolt: Maximum voltage in microvolts
 * regulator-always-on: Never turn off this regulator
 * regulator-boot-on: Turn on during boot
 * enable-active-high: GPIO is active high (vs active low)
 * gpio: GPIO for enable control
 * vin-supply: Parent regulator (power source)
 * regulator-ramp-delay: Voltage ramp delay in uV/us
 * regulator-settling-time-us: Time to wait after enable
 *
 * Common Tegra234 Power Domains:
 * ===============================
 *
 * TEGRA234_POWER_DOMAIN_PCIEX4A: PCIe x4 controller A
 * TEGRA234_POWER_DOMAIN_PCIEX4B: PCIe x4 controller B
 * TEGRA234_POWER_DOMAIN_PCIEX8A: PCIe x8 controller A
 * TEGRA234_POWER_DOMAIN_GPU: GPU domain
 * TEGRA234_POWER_DOMAIN_DISP: Display domain
 * TEGRA234_POWER_DOMAIN_NVDEC: Video decoder
 * TEGRA234_POWER_DOMAIN_NVENC: Video encoder
 * TEGRA234_POWER_DOMAIN_VIC: Video image compositor
 */
