# interview-jetson-orin.conf - Machine configuration for Jetson Orin AGX
#
# This file defines a custom machine configuration for NVIDIA Jetson Orin AGX.
# Machine configs specify hardware-specific settings: architecture, kernel,
# bootloader, GPU support, and hardware features.
#
# Learning objectives:
# 1. Understand machine configuration structure
# 2. Learn hardware capability declaration (MACHINE_FEATURES)
# 3. Practice BSP integration and customization
# 4. Handle SOC-specific compiler and kernel settings

#@TYPE: Machine
#@NAME: Interview Study Jetson Orin AGX
#@DESCRIPTION: Custom machine configuration for NVIDIA Jetson Orin AGX development platform
#@MAINTAINER: Interview Study Team <team@example.com>

# Include base Jetson Orin configuration from meta-tegra
# This provides fundamental Tegra234 support
require conf/machine/jetson-orin-agx-devkit.conf

# Alternative: Define from scratch (more control, more work)
# In that case, uncomment and configure all sections below

# SOC family identification
# Used for conditional recipe inclusion and features
SOC_FAMILY = "tegra234"

# Machine architecture
# Jetson Orin uses ARM64 (aarch64)
DEFAULTTUNE = "armv8a-crc-crypto"

# Include ARM tuning for ARMv8
require conf/machine/include/arm/armv8a/tune-cortexa78.inc

# Kernel configuration
PREFERRED_PROVIDER_virtual/kernel = "linux-tegra"
PREFERRED_VERSION_linux-tegra = "5.10%"

# Kernel image type
KERNEL_IMAGETYPE = "Image"
KERNEL_IMAGETYPES = "Image Image.gz"

# Kernel device tree
# Jetson Orin DTB files
KERNEL_DEVICETREE = " \
    nvidia/tegra234-p3701-0000-p3737-0000.dtb \
    nvidia/tegra234-p3701-0000-p3737-0000-overlay.dtbo \
"

# Custom device tree overlays
KERNEL_DEVICETREE:append = " \
    nvidia/interview-study-gpio.dtbo \
    nvidia/interview-study-i2c.dtbo \
    nvidia/interview-study-spi.dtbo \
"

# Bootloader configuration
PREFERRED_PROVIDER_virtual/bootloader = "cboot-t234"
UBOOT_MACHINE = "p3701-0000_defconfig"

# Machine features
# Declares hardware capabilities available on this platform
MACHINE_FEATURES = " \
    alsa \
    bluetooth \
    ext2 \
    pci \
    pcie \
    screen \
    usbgadget \
    usbhost \
    vfat \
    wifi \
    cuda \
    nvme \
"

# Serial console configuration
SERIAL_CONSOLES = "115200;ttyTCU0"

# Extra kernel command-line arguments
KERNEL_ARGS = "console=ttyTCU0,115200 rootwait rootfstype=ext4"

# Root filesystem type
# Options: ext4, ext3, ext2, btrfs
IMAGE_FSTYPES = "ext4 tar.gz wic.bmap wic.gz"

# WIC (disk image) configuration
WKS_FILE = "jetson-orin-agx.wks"
WKS_FILE_DEPENDS = "tegra-binaries"

# GPU configuration
# CUDA compute capability for Orin (Ampere architecture)
CUDA_ARCHITECTURES = "87"
CUDA_NVCC_ARCH_FLAGS = "-gencode arch=compute_87,code=sm_87"

# CUDA and GPU packages
MACHINE_ESSENTIAL_EXTRA_RDEPENDS = " \
    kernel-image \
    kernel-devicetree \
    kernel-modules \
    tegra-firmware \
    tegra-nvpmodel \
    tegra-configs \
"

# CUDA toolkit version
PREFERRED_VERSION_cuda-toolkit = "11.8%"
PREFERRED_VERSION_cudnn = "8.6%"
PREFERRED_VERSION_tensorrt = "8.6%"

# Graphics and multimedia
PREFERRED_PROVIDER_virtual/egl = "libglvnd"
PREFERRED_PROVIDER_virtual/libgles1 = "libglvnd"
PREFERRED_PROVIDER_virtual/libgles2 = "libglvnd"
PREFERRED_PROVIDER_virtual/libgl = "libglvnd"

# GStreamer plugins for hardware acceleration
MACHINE_GSTREAMER_PLUGINS = " \
    gstreamer1.0-plugins-nvvideoconvert \
    gstreamer1.0-plugins-nvarguscamerasrc \
    gstreamer1.0-plugins-nvv4l2camerasrc \
    gstreamer1.0-plugins-nvjpegenc \
    gstreamer1.0-plugins-nvjpegdec \
"

# DLA (Deep Learning Accelerator) support
# Orin has 2 DLA cores
DLA_CORES = "2"
TENSORRT_ENABLE_DLA = "1"

# Camera support (CSI cameras via Argus)
MACHINE_EXTRA_RDEPENDS:append = " \
    libargus \
    tegra-libraries-argus \
    tegra-libraries-camera \
"

# Networking configuration
# PCIe-based WiFi/Bluetooth module
MACHINE_EXTRA_RRECOMMENDS = " \
    linux-firmware-bcm4354 \
    linux-firmware-bcmdhd \
"

# Storage
# Orin supports NVMe SSDs via PCIe
MACHINE_FEATURES:append = " nvme"

# Extra packages specific to this machine
MACHINE_EXTRA_RDEPENDS:append = " \
    tegra-tools \
    jetson-gpio \
    gpio-tool \
"

# Power management
# nvpmodel profiles for different power modes
NVPMODEL_CONFIG_DEFAULT = "MODE_15W"

# CPU governor
# Options: performance, powersave, ondemand, conservative, schedutil
CPU_GOVERNOR = "schedutil"

# Package architecture
# Machine-specific packages (not compatible with other machines)
PACKAGE_ARCH = "${MACHINE_ARCH}"

# Toolchain configuration
# Compiler flags for Cortex-A78 (Orin CPU cores)
TUNE_CCARGS:append = " -mcpu=cortex-a78 -mtune=cortex-a78"

# Optimization flags
TARGET_CFLAGS:append = " -O3 -ffast-math"
TARGET_CXXFLAGS:append = " -O3 -ffast-math"

# Linker flags
TARGET_LDFLAGS:append = " -Wl,--as-needed"

# Image overhead factor
# Multiplier for root filesystem size calculation
IMAGE_OVERHEAD_FACTOR = "1.3"

# Extra image space (in KB)
IMAGE_ROOTFS_EXTRA_SPACE = "1048576"  # 1GB

# Wic configuration for bootable SD card/eMMC/NVMe image
# Example WKS file content (jetson-orin-agx.wks):
#
# part /boot --source bootimg-partition --ondisk mmcblk0 --fstype=vfat --label boot --active --align 4096 --size 256M
# part / --source rootfs --ondisk mmcblk0 --fstype=ext4 --label root --align 4096 --size 16G
# part /data --ondisk mmcblk0 --fstype=ext4 --label data --align 4096 --size 32G

# Systemd configuration
INIT_MANAGER = "systemd"
DISTRO_FEATURES:append = " systemd"
DISTRO_FEATURES_BACKFILL_CONSIDERED:append = " sysvinit"

# Security features
DISTRO_FEATURES:append = " pam"

# Development features
# Remove in production builds
EXTRA_IMAGE_FEATURES:append = " debug-tweaks tools-debug tools-profile"

# SDK configuration
# Cross-compilation SDK for this machine
SDKMACHINE = "x86_64"

# Preferred providers for SDK
PREFERRED_PROVIDER_nativesdk-cuda-toolkit = "nativesdk-cuda-toolkit"

# Flash tool configuration
# Used for flashing Jetson devices
TNSPEC_MACHINE = "3701-0000-as-3737-0000"

# Tegra binaries version
PREFERRED_VERSION_tegra-binaries = "35.5.0"

# U-Boot configuration (if using U-Boot instead of cboot)
# PREFERRED_PROVIDER_virtual/bootloader = "u-boot-tegra"
# UBOOT_MACHINE = "p3701-0000_defconfig"
# UBOOT_EXTLINUX = "1"
# UBOOT_EXTLINUX_ROOT = "root=/dev/mmcblk0p1"

# Custom machine-specific tasks
# Example: Generate hardware documentation
# do_generate_hw_docs[depends] += "virtual/kernel:do_shared_workdir"
# do_generate_hw_docs() {
#     # Generate pinmux documentation
#     # Generate GPIO mapping tables
#     # etc.
# }

# Machine testing configuration
# TEST_TARGET = "simpleremote"
# TEST_TARGET_IP = "192.168.1.100"
# TEST_SERVER_IP = "192.168.1.1"

# Compatible layers check
# INHERIT += "sanity"
# SANITY_REQUIRED_UTILITIES:append = " nvidia-smi"

# Machine-specific distro features
# MACHINE_DISTRO_FEATURES = "cuda tensorrt dla nvme"

# Example of conditional configuration based on image type:
# IMAGE_BOOT_FILES:interview-study-image = " \
#     Image \
#     tegra234-p3701-0000-p3737-0000.dtb \
# "

# Custom machine tasks for Jetson
# Example: Flash target after build
# addtask flash_target after do_image_complete
# do_flash_target() {
#     echo "Flashing Jetson Orin..."
#     # sudo ./flash.sh jetson-orin-agx-devkit mmcblk0p1
# }

# Usage:
# Set MACHINE = "interview-jetson-orin" in local.conf
# Then build: bitbake custom-image

# Machine debugging:
# bitbake -e | grep ^MACHINE=                   # Verify machine name
# bitbake -e | grep ^MACHINE_FEATURES=          # Check machine features
# bitbake -e | grep ^DEFAULTTUNE=               # Check architecture tuning
# bitbake -e | grep ^PREFERRED_PROVIDER_virtual/kernel=  # Check kernel provider
# bitbake virtual/kernel -c menuconfig          # Configure kernel
# bitbake -c deploy_data custom-image           # Deploy image artifacts
