# meta-interview-study/conf/layer.conf - Layer configuration file
#
# This file defines the meta-interview-study layer configuration for Yocto/OpenEmbedded.
# It specifies layer metadata, dependencies, priorities, and version compatibility.
#
# Learning objectives:
# 1. Understand layer.conf structure and required variables
# 2. Learn layer dependency management (LAYERDEPENDS)
# 3. Practice version compatibility specification
# 4. Handle layer priorities for recipe override control

# We have a conf and classes directory, add to BBPATH
BBPATH .= ":${LAYERDIR}"

# We have recipes-* directories, add to BBFILES
# This makes BitBake aware of all .bb and .bbappend files in this layer
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb \
            ${LAYERDIR}/recipes-*/*/*.bbappend"

# Layer collection name - must be unique across all layers
# Used in LAYERDEPENDS and LAYERSERIES_COMPAT
BBFILE_COLLECTIONS += "meta-interview-study"

# Pattern to match files from this layer in BBFILES
# Helps BitBake identify which files belong to this layer
BBFILE_PATTERN_meta-interview-study = "^${LAYERDIR}/"

# Priority of recipes in this layer (default is 5)
# Higher priority = higher precedence when multiple layers provide same recipe
# Priority range: 1-10 (1=lowest, 10=highest)
# Use 6-7 for application layers, 8-9 for BSP layers
BBFILE_PRIORITY_meta-interview-study = "7"

# Layer name and version
LAYERVERSION_meta-interview-study = "1"

# Layer dependencies - other layers required by this layer
# Format: "layer-name:optional-version"
LAYERDEPENDS_meta-interview-study = " \
    core \
    openembedded-layer \
"

# Conditional dependency on meta-tegra (for Jetson support)
# Only required when building for Jetson platforms
LAYERDEPENDS_meta-interview-study += " \
    ${@'meta-tegra' if d.getVar('MACHINE').startswith('jetson') or 'tegra' in d.getVar('SOC_FAMILY', True) or '' else ''} \
"

# Layer series compatibility
# Specifies which Yocto releases this layer is compatible with
# Update this list as you test with newer Yocto releases
LAYERSERIES_COMPAT_meta-interview-study = "kirkstone langdale mickledore nanbield scarthgap"

# Recipe name mapping (for renamed recipes)
# BBFILE_PATTERN_IGNORE_EMPTY_meta-interview-study = "1"

# Documentation directory
DOC_DIR = "${LAYERDIR}/doc"

# Example directory for reference applications
EXAMPLES_DIR = "${LAYERDIR}/examples"

# Layer-specific variables

# Default CUDA architecture for this layer's recipes
# Override in local.conf or machine config if different
CUDA_ARCH ??= "sm_87"  # Jetson Orin default

# Default TensorRT version
TENSORRT_VERSION ??= "8.6"

# Enable custom package group by default
INTERVIEW_STUDY_PACKAGEGROUP ??= "packagegroup-interview-study"

# Path to layer's machine configurations
BBFILES += "${LAYERDIR}/conf/machine/*.conf"

# Class files directory
# Classes in this directory are automatically available to all recipes
BBFILES += "${LAYERDIR}/classes/*.bbclass"

# Layer sanity check
# Validates that required variables are set
# SANITY_REQUIRED_UTILITIES:append = " cuda-capable-gpu"

# Dynamic layer support
# Enable/disable parts of layer based on available layers
# Checked in recipes using ${@bb.utils.contains_any('BBFILE_COLLECTIONS', 'meta-tegra', ...)}

# License files directory
# Provides license templates for recipes in this layer
LICENSE_PATH += "${LAYERDIR}/licenses"

# Layer README and documentation
LAYER_README = "${LAYERDIR}/README.md"

# Preferred providers for virtual packages
# Example: prefer our custom kernel over others
# PREFERRED_PROVIDER_virtual/kernel:jetson-orin = "linux-tegra"

# Preferred versions (if needed)
# PREFERRED_VERSION_cuda-toolkit = "11.8%"
# PREFERRED_VERSION_tensorrt = "8.6%"

# Machine override order (if needed)
# Ensures machine-specific settings take precedence
# MACHINEOVERRIDES:prepend:jetson-orin = "tegra234:"

# Add layer-specific sstate mirror (if available)
# SSTATE_MIRRORS:append = " file://.* http://example.com/sstate-cache/PATH \n "

# Layer maintenance information
LAYER_MAINTAINER = "Interview Study Team <team@example.com>"
LAYER_HOMEPAGE = "https://github.com/example/meta-interview-study"

# BitBake environment setup hook (optional)
# Runs when layer is initialized
# LAYERDIR_RE = "${LAYERDIR}"

# Advanced: Dynamic layer configuration
# python __anonymous() {
#     # Python code to run during recipe parsing
#     # Can modify variables dynamically based on build configuration
#     machine = d.getVar('MACHINE')
#     if machine and machine.startswith('jetson'):
#         d.appendVar('PREFERRED_PROVIDER_virtual/kernel', 'linux-tegra')
# }

# Recipe-specific default variables
# These can be overridden in local.conf or machine configs

# GPIO tool defaults
GPIO_TOOL_DEFAULT_CHIP ??= "gpiochip0"

# TensorRT optimization defaults
TENSORRT_ENABLE_FP16 ??= "1"
TENSORRT_ENABLE_INT8 ??= "0"
TENSORRT_MAX_WORKSPACE ??= "1073741824"  # 1GB

# CUDA compilation defaults
CUDA_ENABLE_FAST_MATH ??= "1"
CUDA_VERBOSE_COMPILE ??= "1"

# systemd service defaults
SYSTEMD_AUTO_ENABLE_DEFAULT ??= "enable"

# Image configuration defaults
IMAGE_ROOTFS_SIZE_DEFAULT ??= "16777216"  # 16GB
IMAGE_ROOTFS_EXTRA_SPACE_DEFAULT ??= "1048576"  # 1GB

# Development mode flag
# Set to "1" for development builds, "0" for production
INTERVIEW_STUDY_DEV_MODE ??= "1"

# Conditional package installation based on dev mode
# CORE_IMAGE_EXTRA_INSTALL:append = "${@'gdb valgrind' if d.getVar('INTERVIEW_STUDY_DEV_MODE') == '1' else ''}"

# Testing configuration
# Enable test suites if in development mode
# INHERIT:append = "${@' testimage' if d.getVar('INTERVIEW_STUDY_DEV_MODE') == '1' else ''}"

# Layer signature for reproducible builds
# BB_SIGNATURE_EXCLUDE_FLAGS:append = " INTERVIEW_STUDY_DEV_MODE"

# Add custom configuration files directory to file search path
FILESEXTRAPATHS:prepend := "${LAYERDIR}/files:"

# Additional BBPATH directories for includes and configuration
BBPATH:prepend = "${LAYERDIR}:"

# Layer-specific distro features
# These can be appended to DISTRO_FEATURES in distro config
LAYER_DISTRO_FEATURES = "systemd cuda tensorrt gpio-control"

# Machine features provided by this layer
LAYER_MACHINE_FEATURES = "cuda tensorrt nvme pcie wifi bluetooth"

# Example of conditional recipe inclusion:
# Include CUDA recipes only if machine has GPU support
# BBMASK:append = "${@'' if bb.utils.contains('MACHINE_FEATURES', 'gpu', True, False, d) else '|meta-interview-study/recipes-cuda/'}"

# Layer usage example in bblayers.conf:
#
# BBLAYERS ?= " \
#   /path/to/poky/meta \
#   /path/to/poky/meta-poky \
#   /path/to/meta-openembedded/meta-oe \
#   /path/to/meta-tegra \
#   /path/to/meta-interview-study \
# "

# Common layer.conf debugging:
# bitbake-layers show-layers                    # Show all layers and priorities
# bitbake-layers show-recipes                   # Show recipes from all layers
# bitbake-layers show-appends                   # Show all .bbappend files
# bitbake-layers show-overlayed                 # Show overlayed recipes
# bitbake-layers layerindex-fetch meta-*        # Fetch layer from index
# bitbake-layers add-layer /path/to/layer       # Add layer to build
